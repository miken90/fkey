# Linux Release Workflow
# Triggered manually to release Linux version independently from Windows
#
# Usage: Actions tab â†’ "Release Linux" â†’ Run workflow â†’ Enter version

name: Release Linux

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: true

env:
  CARGO_TERM_COLOR: always

jobs:
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libgtk-3-dev \
          libx11-dev \
          xdotool \
          libayatana-appindicator3-dev

    - name: Setup Rust
      uses: dtolnay/rust-action@stable

    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          core/target
        key: ${{ runner.os }}-cargo-${{ hashFiles('core/Cargo.lock') }}

    - name: Build Rust core
      working-directory: core
      run: cargo build --release

    - name: Build Go application
      working-directory: platforms/linux
      env:
        VERSION: ${{ inputs.version }}
        CGO_ENABLED: 1
        CGO_LDFLAGS: "-L../../core/target/release -lgonhanh_core"
      run: |
        go mod tidy
        go build -ldflags "-X main.Version=${VERSION}" -o fkey .

    - name: Prepare release artifacts
      run: |
        VERSION="${{ inputs.version }}"
        RELEASE_DIR="FKey-${VERSION}-linux-x86_64"
        
        mkdir -p "${RELEASE_DIR}"
        
        # Copy binary
        cp platforms/linux/fkey "${RELEASE_DIR}/"
        
        # Copy Rust library
        cp core/target/release/libgonhanh_core.so "${RELEASE_DIR}/"
        
        # Copy desktop file
        cp platforms/linux/fkey.desktop "${RELEASE_DIR}/"
        
        # Create install script
        cat > "${RELEASE_DIR}/install.sh" << 'EOF'
        #!/bin/bash
        set -e
        
        echo "Installing FKey Vietnamese IME..."
        
        # Install binary
        sudo install -Dm755 fkey /usr/local/bin/fkey
        
        # Install library
        sudo install -Dm644 libgonhanh_core.so /usr/local/lib/libgonhanh_core.so
        sudo ldconfig
        
        # Install desktop file
        install -Dm644 fkey.desktop ~/.local/share/applications/fkey.desktop
        
        echo "âœ“ FKey installed successfully!"
        echo "  Run: fkey"
        echo "  Or find 'FKey' in your application menu"
        EOF
        chmod +x "${RELEASE_DIR}/install.sh"
        
        # Create uninstall script
        cat > "${RELEASE_DIR}/uninstall.sh" << 'EOF'
        #!/bin/bash
        set -e
        
        echo "Uninstalling FKey..."
        
        sudo rm -f /usr/local/bin/fkey
        sudo rm -f /usr/local/lib/libgonhanh_core.so
        rm -f ~/.local/share/applications/fkey.desktop
        sudo ldconfig
        
        echo "âœ“ FKey uninstalled"
        EOF
        chmod +x "${RELEASE_DIR}/uninstall.sh"
        
        # Create README
        cat > "${RELEASE_DIR}/README.txt" << EOF
        FKey ${VERSION} - Vietnamese Input Method for Linux
        ================================================
        
        REQUIREMENTS:
        - X11 (Wayland not yet supported)
        - xdotool: sudo apt install xdotool
        
        INSTALL:
        ./install.sh
        
        RUN:
        fkey
        
        USAGE:
        - Toggle: Ctrl+Space (default)
        - Right-click tray icon for menu
        - Config: ~/.config/fkey/config.toml
        
        UNINSTALL:
        ./uninstall.sh
        
        More info: https://github.com/miken90/fkey
        EOF
        
        # Create tar.gz
        tar -czvf "FKey-${VERSION}-linux-x86_64.tar.gz" "${RELEASE_DIR}"
        
        echo "RELEASE_FILE=FKey-${VERSION}-linux-x86_64.tar.gz" >> $GITHUB_ENV
        echo "RELEASE_DIR=${RELEASE_DIR}" >> $GITHUB_ENV

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ inputs.version }}-linux
        name: FKey v${{ inputs.version }} (Linux)
        body: |
          ## FKey v${{ inputs.version }} for Linux
          
          Vietnamese Input Method for Linux (X11)
          
          ### Installation
          
          ```bash
          # Extract
          tar -xzvf FKey-${{ inputs.version }}-linux-x86_64.tar.gz
          cd FKey-${{ inputs.version }}-linux-x86_64
          
          # Install
          ./install.sh
          
          # Run
          fkey
          ```
          
          ### Requirements
          - Linux with X11 (Wayland not yet supported)
          - xdotool: `sudo apt install xdotool`
          
          ### Features
          - Telex and VNI input methods
          - Modern/Traditional tone placement
          - System tray with GTK3
          - Toggle hotkey: Ctrl+Space
          
          ---
          âš ï¸ **Pre-release**: This is an early Linux port. Please report issues!
        draft: false
        prerelease: ${{ inputs.prerelease }}
        files: |
          ${{ env.RELEASE_FILE }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Summary
      run: |
        echo "## ðŸ§ Linux Release Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**File:** ${{ env.RELEASE_FILE }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Release page: https://github.com/${{ github.repository }}/releases/tag/v${{ inputs.version }}-linux" >> $GITHUB_STEP_SUMMARY
